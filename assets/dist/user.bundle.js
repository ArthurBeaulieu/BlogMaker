!function(){"use strict";var e=Object.freeze({OK:200,NOT_FOUND:404,FORBIDDEN:403,INTERNAL_ERROR:500});function t(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var r=function(){function r(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this._jwtToken=e||null,this._headers=this._createRequestHeaders()}var n,o;return n=r,(o=[{key:"_createRequestHeaders",value:function(){return[["Content-Type","application/json; charset=UTF-8"],["Accept","application/json"],["X-XSRF-TOKEN",this._jwtToken]]}},{key:"_getErrorCodeFromHTTPStatus",value:function(t){return t===e.NOT_FOUND?"B_KOM_NOT_FOUND":t===e.FORBIDDEN?"B_KOM_ACCESS_FORBIDDEN":t===e.INTERNAL_ERROR?"B_KOM_INTERNAL_ERROR":"B_KOM_UNKNOWN_ERROR"}},{key:"_resolveAs",value:function(t,r){var n=this;return new Promise((function(o,s){r?"raw"===t?r.status===e.OK?o(r.responseText):s(n._getErrorCodeFromHTTPStatus(r.status)):"json"===t||"text"===t?r[t]?o(r[t]()):s(n._getErrorCodeFromHTTPStatus(r.status)):s("F_KOM_UNSUPPORTED_TYPE"):s("F_KOM_MISSING_ARGUMENT")}))}},{key:"_resolveAsJSON",value:function(e){return this._resolveAs("json",e)}},{key:"_resolveAsText",value:function(e){return this._resolveAs("text",e)}},{key:"_resolveAsRaw",value:function(e){return this._resolveAs("raw",e)}},{key:"_xhrCall",value:function(e,t,r){var n=this;return new Promise((function(o,s){var a=new XMLHttpRequest;a.open(t,e,!0),a.overrideMimeType("text/plain; charset=x-user-defined"),a.onreadystatechange=function(e){4===e.target.readyState&&n._resolveAsRaw(e.target).then(o).catch(s)},a.onerror=function(){s({code:"F_KOM_XHR_ERROR"})},a.send(r)}))}},{key:"get",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._resolveAsJSON.bind(this);return new Promise((function(n,o){var s={method:"GET",headers:new Headers([t._headers[0]])};fetch(e,s).then(r).then(n).catch(o)}))}},{key:"getText",value:function(e){return this.get(e,this._resolveAsText.bind(this))}},{key:"getRaw",value:function(e){var t=this;return new Promise((function(r,n){t._xhrCall(e,"GET",null).then(r).catch(n)}))}},{key:"post",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._resolveAsJSON.bind(this);return new Promise((function(o,s){var a={method:"POST",headers:new Headers(r._headers),body:JSON.stringify(t)};fetch(e,a).then(n).then(o).catch(s)}))}},{key:"postText",value:function(e,t){return this.post(e,t,this._resolveAsText.bind(this))}},{key:"postRaw",value:function(e,t){var r=this;return new Promise((function(n,o){r._xhrCall(e,"POST",JSON.stringify(t)).then(n).catch(o)}))}},{key:"postForm",value:function(e,t){return new Promise((function(r,n){var o=document.createElement("FORM");for(var s in o.method="POST",o.action=e,t)if(Object.prototype.hasOwnProperty.call(t,s)){var a=document.createElement("INPUT");a.type="hidden",a.name=s,a.value=t[s],o.appendChild(a)}var i=new XMLHttpRequest;i.open("POST",e),i.onreadystatechange=function(e){if(4===e.target.readyState)try{var t=JSON.parse(e.target.response);r(t)}catch(t){n(e.target.response)}},i.onerror=function(){n("F_KOM_XHR_ERROR")};var u=new FormData(o);i.send(u)}))}},{key:"xhr",value:function(e,t,r){return new Promise((function(n,o){var s=new XMLHttpRequest;s.open(e,t,!0),s.onreadystatechange=function(){4===s.readyState&&n(JSON.parse(s.responseText))},s.onerror=function(){o({code:"F_KOM_XHR_ERROR"})},s.send(r)}))}},{key:"jwtToken",get:function(){return this._jwtToken},set:function(e){this._jwtToken=e}}])&&t(n.prototype,o),r}();function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];o(this,e),"boolean"!=typeof t&&(t=!1),this._debug=t,this._idIncrementor=5678*Math.floor(Math.random()*Math.floor(256)),this._regularEvents=[],this._customEvents={},this.version="1.2.1"}var t,r;return t=e,(r=[{key:"destroy",value:function(){var e=this;this._raise("log","CustomEvents.destroy"),this.removeAllEvents(),Object.keys(this).forEach((function(t){delete e[t]}))}},{key:"addEvent",value:function(e,t,r){var o=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(this._raise("log","CustomEvents.addEvent: ".concat(e," ").concat(t," ").concat(r," ").concat(s," ").concat(a)),null==e||null==t||null==r)return this._raise("error","CustomEvents.addEvent: Missing mandatory arguments"),!1;var i=function(){o._raise("error","CustomEvents.addEvent: Wrong type for argument")};return"string"!=typeof e||"object"!==n(t)||"function"!=typeof r||null!=s&&"object"!==n(s)||null!=a&&"object"!==n(a)&&"boolean"!=typeof a?(i(),!1):(r=r.bind(s),this._regularEvents.push({id:this._idIncrementor,element:t,eventName:e,scope:s,callback:r,options:a}),t.addEventListener(e,r,a),this._idIncrementor++)}},{key:"removeEvent",value:function(e){if(this._raise("log","Events.removeEvent: ".concat(e)),null==e)return this._raise("error","CustomEvents.removeEvent: Missing mandatory arguments"),!1;if("number"!=typeof e)return this._raise("error","CustomEvents.removeEvent: Wrong type for argument"),!1;for(var t=!1,r=this._regularEvents.length-1;r>=0;--r)this._regularEvents[r].id===e&&(t=!0,this._clearRegularEvent(r));return t}},{key:"removeAllEvents",value:function(){this._raise("log","CustomEvents.removeAllEvents");for(var e=!1,t=this._regularEvents.length>0,r=this._regularEvents.length-1;r>=0;--r)this._clearRegularEvent(r);return 0===this._regularEvents.length&&t&&(e=!0),e}},{key:"_clearRegularEvent",value:function(e){if(this._raise("log","CustomEvents._clearRegularEvent: ".concat(e)),null==e)return this._raise("error","CustomEvents._clearRegularEvent: Missing mandatory argument"),!1;if("number"!=typeof e)return this._raise("error","CustomEvents._clearRegularEvent: Wrong type for argument"),!1;if(this._regularEvents[e]){var t=this._regularEvents[e];return t.element.removeEventListener(t.eventName,t.callback,t.options),this._regularEvents.splice(e,1),!0}return!1}},{key:"subscribe",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._raise("log","CustomEvents.subscribe: ".concat(e," ").concat(t," ").concat(n)),null==e||null==t)return this._raise("error","CustomEvents.subscribe","Missing mandatory arguments"),!1;var o=function(){r._raise("error","CustomEvents.subscribe: Wrong type for argument")};return"string"!=typeof e||"function"!=typeof t||null!=n&&"boolean"!=typeof n?(o(),!1):(this._customEvents[e]||(this._customEvents[e]=[]),this._customEvents[e].push({id:this._idIncrementor,name:e,os:n,callback:t}),this._idIncrementor++)}},{key:"unsubscribe",value:function(e){if(this._raise("log","CustomEvents.unsubscribe: ".concat(e)),null==e)return this._raise("error","CustomEvents.unsubscribe: Missing mandatory arguments"),!1;if("number"!=typeof e)return this._raise("error","CustomEvents.unsubscribe: Wrong type for argument"),!1;for(var t=!1,r=Object.keys(this._customEvents),n=r.length-1;n>=0;--n)for(var o=this._customEvents[r[n]],s=0;s<o.length;++s)if(o[s].id===e){this._raise("log","CustomEvents.unsubscribe: subscription found\n",o[s],"\nSubscription n°".concat(e," for ").concat(o.name," has been removed")),t=!0,o.splice(s,1),0===o.length&&delete this._customEvents[r[n]];break}return t}},{key:"unsubscribeAllFor",value:function(e){if(this._raise("log","CustomEvents.unsubscribeAllFor: ".concat(e)),null==e)return this._raise("error","CustomEvents.unsubscribeAllFor: Missing mandatory arguments"),!1;if("string"!=typeof e)return this._raise("error","CustomEvents.unsubscribeAllFor: Wrong type for argument"),!1;for(var t=!1,r=Object.keys(this._customEvents),n=0;n<r.length;++n)if(r[n]===e)for(var o=this._customEvents[r[n]],s=o.length-1;s>=0;--s)t=!0,o.splice(s,1),0===o.length&&delete this._customEvents[r[n]];return t}},{key:"publish",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this._raise("log","CustomEvents.publish: ".concat(e," ").concat(t)),null==e)return this._raise("error","CustomEvents.publish: Missing mandatory arguments"),!1;if("string"!=typeof e||void 0!==t&&"object"!==n(t))return this._raise("error","CustomEvents.publish: Wrong type for argument"),!1;for(var r=!1,o=Object.keys(this._customEvents),s=0;s<o.length;++s)if(o[s]===e){r=!0;for(var a=this._customEvents[o[s]],i=a.length-1;i>=0;--i)this._raise("log","CustomEvents.publish: fire callback for ".concat(e,", subscription n°").concat(a[i].id),a[i]),a[i].callback(t),a[i].os&&(this._raise("log","CustomEvents.publish: remove subscription because one shot usage is done"),a.splice(i,1),0===a.length&&delete this._customEvents[o[s]])}return r}},{key:"_raise",value:function(e,t){this._debug&&console[e](t)}}])&&s(t.prototype,r),e}();function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,r){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(r):o.value}})(e,t,r||e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e,t){return!t||"object"!==u(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _={DeleteAccountModal:function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(a,e);var t,r,n,o,s=(n=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=f(n);if(o){var r=f(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return v(this,e)});function a(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(t=s.call(this,e))._cb=e.cb,t._deleteButton=null,t._deleteEvtId=-1,t}return t=a,(r=[{key:"destroy",value:function(){c(f(a.prototype),"destroy",this).call(this),window.events.removeEvent(this._deleteEvtId)}},{key:"_fillAttributes",value:function(){this._deleteButton=this._modalOverlay.querySelector("#modal-user-delete-button"),this._events()}},{key:"_events",value:function(){this._deleteEvtId=window.events.addEvent("click",this._deleteButton,this._deleteClicked,this)}},{key:"_deleteClicked",value:function(e){e.preventDefault(),this.close(),this._cb()}}])&&l(t.prototype,r),a}(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._url=t.url,this._modalOverlay=null,this._overlayClickedEvtId=-1,this._closeButtons=null,this._closeClickedEvtIds=[],this._loadTemplate()}var t,r;return t=e,(r=[{key:"destroy",value:function(){window.events.removeEvent(this._overlayClickedEvtId);for(var e=0;e<this._closeButtons.length;++e)window.events.removeEvent(this._closeClickedEvtIds[e]);delete this._url,delete this._modalOverlay,delete this._overlayClickedEvtId,delete this._closeButtons,delete this._closeClickedEvtIds}},{key:"_loadTemplate",value:function(){var e=this;window.kom.getText(this._url).then((function(t){e._modalOverlay=e.parseHTMLFragment(t),e._closeButtons=e._modalOverlay.querySelectorAll(".modal-close"),e.open(),e._fillAttributes()})).catch((function(e){console.error(e)}))}},{key:"_fillAttributes",value:function(){}},{key:"parseHTMLFragment",value:function(e){return(new DOMParser).parseFromString(e,"text/html").body.firstChild}},{key:"open",value:function(){document.body.appendChild(this._modalOverlay),this._overlayClickedEvtId=window.events.addEvent("click",this._modalOverlay,this.close,this);for(var e=0;e<this._closeButtons.length;++e)this._closeClickedEvtIds.push(window.events.addEvent("click",this._closeButtons[e],this.close,this))}},{key:"close",value:function(e){for(var t=0;t<this._closeButtons.length;++t)if(!e||e&&(e.target===this._modalOverlay||e.target===this._closeButtons[t]))return document.body.removeChild(this._modalOverlay),void this.destroy()}}])&&i(t.prototype,r),e}())},m=function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h(this,e),new(_["".concat(t,"Modal")])(r)},p=new r;window.kom=p;var y=new a;window.events=y;var E=function(e){for(var t=Object.keys(e),r=0;r<t.length;++r)e[t[r]].classList.remove("error")},g=document.querySelector("#edit-profile-info-submit");if(g){var b={username:document.querySelector("#username"),email:document.querySelector("#email"),error:document.querySelector("#error-output"),loading:document.querySelector("#line-loader")},O=function(e){b.loading.style.opacity="0",200===e.status?(b.username.value=e.info.username,b.email.value=e.info.email,e.taken.username&&b.username.classList.add("error"),e.taken.email&&b.email.classList.add("error"),e.message&&(b.error.innerHTML=e.message)):"B_PROFILE_UPDATE_INFO_INVALID_FIELD"===e.code||"B_PROFILE_UPDATE_INFO_MISSING_FIELD"===e.code?(b.username.classList.add("error"),b.email.classList.add("error")):"B_PROFILE_UPDATE_INFO_NO_CHANGES"===e.code&&(b.error.innerHTML=e.message)};g.addEventListener("click",(function(e){e.preventDefault();var t=new FormData(document.querySelector("#edit-profile-info-form")),r=Object.fromEntries(t.entries());b.loading.style.opacity="1",b.error.innerHTML="",E(b),p.post("/api/user/update/info",r).then(O).catch(O)}))}var S=document.querySelector("#edit-profile-password-submit");if(S){var R={pass1:document.querySelector("#pass1"),pass2:document.querySelector("#pass2"),pass3:document.querySelector("#pass3"),error:document.querySelector("#error-output"),loading:document.querySelector("#line-loader")},w=function(e){R.loading.style.opacity="0",R.error.innerHTML=e.message,200===e.status?(R.pass1.value="",R.pass2.value="",R.pass3.value=""):(R.error.classList.add("error"),"B_PROFILE_UPDATE_PASSWORD_INVALID_FIELD"===e.code||"B_PROFILE_UPDATE_PASSWORD_EMPTY_FIELD"===e.code?(R.pass1.classList.add("error"),R.pass2.classList.add("error"),R.pass3.classList.add("error")):"B_PROFILE_UPDATE_PASSWORD_MISSING_FIELD"===e.code?(e.missing.pass1&&R.pass1.classList.add("error"),e.missing.pass2&&R.pass2.classList.add("error"),e.missing.pass3&&R.pass3.classList.add("error")):"B_PROFILE_UPDATE_PASSWORD_DIFFERENT_PASSWORDS"===e.code?(R.pass2.classList.add("error"),R.pass3.classList.add("error")):"B_PROFILE_UPDATE_PASSWORD_SAME_PASSWORDS"===e.code?(R.pass1.classList.add("error"),R.pass2.classList.add("error"),R.pass3.classList.add("error")):"B_PROFILE_UPDATE_PASSWORD_PASSWORD_TOO_SHORT"===e.code?(R.pass2.classList.add("error"),R.pass3.classList.add("error")):"B_PROFILE_UPDATE_PASSWORD_INVALID_PASSWORD"===e.code&&R.pass1.classList.add("error"))};S.addEventListener("click",(function(e){e.preventDefault();var t=new FormData(document.querySelector("#edit-profile-password-form")),r=Object.fromEntries(t.entries());R.loading.style.opacity="1",R.error.innerHTML="",E(R),p.post("/api/user/update/password",r).then(w).catch(w)}))}var k=document.querySelector("#upload-profile-avatar-submit");k&&function(){for(var e={avatar:document.querySelector("#avatar"),error:document.querySelector("#error-output"),loading:document.querySelector("#line-loader")},t=function(t){e.loading.style.opacity="0",e.error.innerHTML=t.message,200===t.status?window.location.href=t.url:(e.error.classList.add("error"),"B_PROFILE_UPDATE_PASSWORD_INVALID_FIELD"===t.code?e.avatar.classList.add("error"):"F_KOM_XHR_ERROR"===t.code?e.error.innerHTML="Error sending avatar to the server":"B_PROFILE_UPLOAD_AVATAR_SIZE_ERROR"===t.code&&e.avatar.classList.add("error"))},r=document.querySelector("#avatars"),n=function(n){var o={src:r.children[n].children[0].src};0!==n&&r.children[n].children[0].addEventListener("click",(function(){e.loading.style.opacity="1",e.error.innerHTML="",E(e),p.post("/api/user/update/avatar",o).then(t).catch(t)})),r.children[n].children[1].addEventListener("click",(function(){e.loading.style.opacity="1",e.error.innerHTML="",E(e),p.post("/api/user/delete/avatar",o).then(t).catch(t)}))},o=0;o<r.children.length;++o)n(o);k.addEventListener("click",(function(r){r.preventDefault();var n=new FormData(document.querySelector("#edit-profile-avatar-form"));e.loading.style.opacity="1",e.error.innerHTML="",E(e),p.xhr("POST","/api/user/upload/avatar",n).then(t).catch(t)}))}();var T=document.querySelector("#delete-account");if(T){var L=document.querySelector("#error-output"),P=function(e){200===e.status?window.location.href=e.url:"B_NEVER_KILL_ROOT"===e.code&&(L.innerHTML=e.message)};T.addEventListener("click",(function(){new m("DeleteAccount",{url:"/template/modal/delete/user",cb:function(){p.get("/api/user/delete").then(P).catch(P)}})}))}window.UserStack={}.default}();